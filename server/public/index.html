<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Asjade Internet</title>
</head>

<script>
  let lastTime = Date.now()
  let values = []
  let allValues = []
  let groups = [0, 0, 0, 0]

  async function status() {
    document.querySelector('#lastFetch').innerText = new Date(Date.now()).toLocaleString()
    let {value, lastUpdate} = await fetch(`/status/last-update`).then((res) => res.json()) ?? 0
    if (lastTime === lastUpdate) {
      allValues.push(value)
      return drawGraph()
    }
    allValues.push(value)
    value = parseInt(value)
    updateGroups(value)
    lastTime = lastUpdate
    values.push(value)
    document.querySelector('#value').innerText = value
    document.querySelector('#lastUpdate').innerText = new Date(lastUpdate).toLocaleString()
    document.querySelector('#color').style.backgroundColor = `rgba(255, 99, 71, ${value / 1000})`
    addToList(value)
    calculate()
    drawGraph()
  }

  function addToList(value) {
    let li = document.createElement('li')
    li.innerText = value
    if (values.length === 1) li.setAttribute('id', 'el-1')
    document.querySelector('#list').prepend(li)
  }

  function calculate() {
    if (!values?.length) return console.log('Could not calculate - insufficient values')

    const size = values.length
    document.querySelector('#highestValue').innerText = Math.max.apply(null, values)
    document.querySelector('#smallestValue').innerText = Math.min.apply(null, values)
    document.querySelector('#averageValue').innerText = values.reduce((prev, curr) => prev + curr, 0) / size

    const mean = values.reduce((a, b) => a + b) / size
    document.querySelector('#stdDeviation').innerText = Math.sqrt(values.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / size)
    document.querySelector('#valueCount').innerText = size
    const average = values.sort((a, b) => a - b).length / 2
    document.querySelector('#median').innerText = average % 1 === 0 ? (values[average - 1] + values[average]) / 2 : values[Math.floor(average)]
  }

  function updateGroups(value, remove = false) {
    if (value >= 0 && value <= 256) remove ? groups[0] -= 1 : groups[0] += 1
    else if (value >= 257 && value <= 512) remove ? groups[1] -= 1 : groups[1] += 1
    else if (value >= 513 && value <= 768) remove ? groups[2] -= 1 : groups[1] += 1
    else if (value >= 769 && value <= 1024) remove ? groups[3] -= 1 : groups[1] += 1
    document.querySelector('#group1').innerText = groups[0]
    document.querySelector('#group2').innerText = groups[1]
    document.querySelector('#group3').innerText = groups[2]
    document.querySelector('#group4').innerText = groups[3]
  }

  function deleteFirst() {
    const firstValue = values.shift()
    allValues.shift()
    document.querySelector('#el-1').remove()
    document.querySelector('#delFirstBtn').remove()
    updateGroups(firstValue, true)
  }

  function drawGraph() {
    const canvas = document.getElementById("canvas");
    const context = canvas.getContext("2d");
    const GRAPH_TOP = 25;
    const GRAPH_BOTTOM = 375;
    const GRAPH_LEFT = 25;
    const GRAPH_RIGHT = 475;
    const GRAPH_HEIGHT = 350;

    context.clearRect(0, 0, 500, 400);

    // draw X and Y axis
    context.beginPath();
    context.strokeStyle = "#f37070";
    context.moveTo( GRAPH_LEFT, GRAPH_BOTTOM );
    context.lineTo( GRAPH_RIGHT, GRAPH_BOTTOM );
    context.lineTo( GRAPH_RIGHT, GRAPH_TOP );
    context.stroke();

    context.beginPath();
    context.strokeStyle = "#e3c8c8";
    context.moveTo( GRAPH_LEFT, GRAPH_TOP );
    context.lineTo( GRAPH_RIGHT, GRAPH_TOP );
    context.stroke();

    context.beginPath();
    context.moveTo( GRAPH_LEFT, ( GRAPH_HEIGHT ) / 4 * 3 + GRAPH_TOP );
    context.lineTo( GRAPH_RIGHT, ( GRAPH_HEIGHT ) / 4 * 3 + GRAPH_TOP );
    context.stroke();

    context.beginPath();
    context.moveTo( GRAPH_LEFT, ( GRAPH_HEIGHT ) / 2 + GRAPH_TOP );
    context.lineTo( GRAPH_RIGHT, ( GRAPH_HEIGHT ) / 2 + GRAPH_TOP );
    context.stroke();

    context.beginPath();
    context.moveTo( GRAPH_LEFT, ( GRAPH_HEIGHT ) / 4 + GRAPH_TOP );
    context.lineTo( GRAPH_RIGHT, ( GRAPH_HEIGHT ) / 4 + GRAPH_TOP );
    context.stroke();

    const size = allValues.length
    const largest = Math.max.apply(null, allValues)

    context.beginPath();
    context.lineJoin = "round";
    context.strokeStyle = "black";
    context.moveTo(GRAPH_LEFT, (GRAPH_HEIGHT - allValues[0] / largest * GRAPH_HEIGHT) + GRAPH_TOP);
    for (let i = 1; i < size; i++) {
      context.lineTo(GRAPH_RIGHT / size * i + GRAPH_LEFT, (GRAPH_HEIGHT - allValues[i] / largest * GRAPH_HEIGHT) + GRAPH_TOP);
    }
    context.stroke();

  }

  document.addEventListener('DOMContentLoaded', () => {
    status()
    setInterval(status, 10000)
  })
</script>

<body>

<div style="display: flex; justify-content: space-around; gap: 2rem">
    <div>
        <h1>Values</h1>
        <input type="button" value="Delete first value" id="delFirstBtn" onclick="deleteFirst()">
        <p>Value count: <span id="valueCount"></span></p>
        <div>
            <ul id="list"></ul>
        </div>
    </div>
    <div style="display: flex; flex-direction: column; justify-content: center; gap: 2rem;">
        <h1 id="value"></h1>
        <h3>Last time value changed <span id="lastUpdate"></span></h3>
        <h3>Last update attempt <span id="lastFetch"></span></h3>
        <p>Highest value: <span id="highestValue"></span></p>
        <p>Smallest value: <span id="smallestValue"></span></p>
        <p>Average value: <span id="averageValue"></span></p>
        <p>Standard deviation: <span id="stdDeviation"></span></p>
        <p>Median: <span id="median"></span></p>
        <canvas id="canvas" width="500" height="500"></canvas>
        <div id="color" style="display:grid; grid-template-columns: 1fr 1fr; height: 500px; width: 500px; border: 1px solid indianred; text-align: center; align-items: center">
            <div><b>0-256:</b> <span id="group1"></span></div>
            <div><b>257-512:</b> <span id="group2"></span></div>
            <div><b>513-768:</b> <span id="group3"></span></div>
            <div><b>769-1024:</b> <span id="group4"></span></div>
        </div>
    </div>
</div>

</body>
</html>