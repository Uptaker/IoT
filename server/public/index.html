<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Asjade Internet</title>
</head>

<script>
  let lastTime = Date.now()
  let values = []

  async function status() {
    let {value, lastUpdate} = await fetch(`/status/last-update`).then((res) => res.json()) ?? 0
    if (lastTime === lastUpdate) return

    value = parseInt(value)
    lastTime = lastUpdate
    values.push(value)
    document.querySelector('#value').innerText = value
    document.querySelector('#lastUpdate').innerText = new Date(lastUpdate).toLocaleString()
    document.querySelector('#color').style.backgroundColor = `rgba(255, 99, 71, ${value / 1000})`
    addToList(value)
    calculate()
  }

  function addToList(value) {
    let li = document.createElement('li')
    li.innerText = value
    if (values.length === 1) li.setAttribute('id', 'el-1')
    document.querySelector('#list').prepend(li)
  }

  function calculate() {
    if (!values?.length) return console.log('Could not calculate - insufficient values')

    const size = values.length
    document.querySelector('#highestValue').innerText = Math.max.apply(null, values)
    document.querySelector('#smallestValue').innerText = Math.min.apply(null, values)
    document.querySelector('#averageValue').innerText = values.reduce((prev, curr) => prev + curr, 0) / size

    const mean = values.reduce((a, b) => a + b) / size
    document.querySelector('#stdDeviation').innerText = Math.sqrt(values.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / size)
    document.querySelector('#valueCount').innerText = size
    const average = values.sort((a, b) =>  a - b).length / 2
    document.querySelector('#median').innerText = average % 1 ===0 ? (values[average - 1] + values[average]) / 2 : values[Math.floor(average)]
  }

  function deleteFirst() {
    values.shift()
    document.querySelector('#el-1').remove()
    document.querySelector('#delFirstBtn').remove()
  }

  document.addEventListener('DOMContentLoaded', () => {
    status()
    setInterval(status, 10000)
  })
</script>

<body>

<div style="display: flex; justify-content: space-around; gap: 2rem">
    <div>
        <h1>Values</h1>
        <input type="button" value="Delete first value" id="delFirstBtn" onclick="deleteFirst()">
        <p>Value count: <span id="valueCount"></span></p>
        <div>
            <ul id="list"></ul>
        </div>
    </div>
    <div style="display: flex; flex-direction: column; justify-content: center; gap: 2rem;">
        <h1 id="value"></h1>
        <h3 id="lastUpdate"></h3>
        <p>Highest value: <span id="highestValue"></span></p>
        <p>Smallest value: <span id="smallestValue"></span></p>
        <p>Average value: <span id="averageValue"></span></p>
        <p>Standard deviation: <span id="stdDeviation"></span></p>
        <p>Median: <span id="median"></span></p>
        <div id="color" style="height: 500px; width: 500px; border: 1px solid indianred"></div>
    </div>
</div>

</body>
</html>